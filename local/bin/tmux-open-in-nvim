#!/bin/sh

# Get current line eiter from argument $1 or from stdin
# Tried using with tmux buffer, but got stale data sometimes
line="${1:-$(cat)}"

if [ -z "$line" ]; then
    echo "Empty line"
    exit 1
fi


# Find first pane running nvim or vim
pane=$(tmux list-panes -F '#{pane_id} #{pane_current_command}' | grep -E 'n?vim' | head -n 1 | awk '{print $1}')

# Le little bit of comment debug xD
# echo "Runinng... on $line $pane"

if [ -n "$pane" ]; then
    # Ensure we're in normal mode, we could be in terminal
    tmux send-keys -t "$pane" Escape Escape ^\\ ^n

    # Open the file and let neovim handled it, expected GotoFileFromLine global function
    # Another option could be do the full filename extrancting from shell and then: tmux send-keys -t "$pane" ":e $file" Enter
    tmux send-keys -t "$pane" ":lua GotoFile [[$line]]" Enter

    # Focus the pane and start typing shit
    tmux select-pane -t "$pane"
else
    echo "Tough luck, no Vim/Neovim instance was found in the current tmux window."
    exit 1
fi
